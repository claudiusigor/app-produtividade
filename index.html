<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Foco Diário</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
        
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --accent-primary: #2563eb;
            --accent-study: #2563eb;
            --accent-gym: #7c3aed;
            --accent-care: #059669;
            --accent-water: #0891b2;
            --accent-run: #ea580c;
        }

        html.dark {
            --bg-primary: #020617;
            --bg-secondary: #0f172a;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #1e293b;
            --accent-primary: #60a5fa;
            --accent-study: #60a5fa;
            --accent-gym: #c084fc;
            --accent-care: #34d399;
            --accent-water: #22d3ee;
            --accent-run: #fb923c;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        html.dark .card:hover {
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        .input-base {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .input-base:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
            border-color: transparent;
        }

        .custom-checkbox {
            appearance: none;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            min-width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.375rem;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .custom-checkbox:checked {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        .custom-checkbox:checked::after {
            content: '✔';
            position: absolute;
            color: white;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
        }
        
        .progress-bar-inner {
            transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid var(--text-secondary);
            border-bottom-color: var(--accent-primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-print { display: block; }
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            main { padding: 0 !important; margin: 0 !important; max-width: 100% !important; }
            .card { box-shadow: none !important; border: 1px solid #d1d5db !important; transform: none !important; }
        }
    </style>
</head>
<body class="transition-colors duration-300">

    <main id="app-container" class="max-w-5xl mx-auto p-4 md:p-8 opacity-0 transition-opacity duration-500">
        <!-- O conteúdo será injetado aqui pelo JavaScript -->
    </main>

    <div id="loader" class="flex flex-col items-center justify-center h-screen text-text-secondary">
        <div class="loader mb-4"></div>
        <p>Carregando seu plano de foco...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E ESTADO INICIAL ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db, auth, userId;
        let isShellRendered = false;

        const getTodayDateString = () => new Date().toISOString().split('T')[0];
        const getWeekId = (date) => {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        };

        const defaultDailyData = {
            study: { tasks: { block1: false, block2: false, review: false }, notes: '' },
            gym: { tasks: { workout: false, cardio: false, cooldown: false }, notes: '' },
            selfCare: { tasks: { dinner: false, shower: false, organize: false, read: false, prepare: false, noPhone: false } },
            water: { completed: 0, goal: 3000 }
        };

        const defaultWeeklyData = {
            goals: { study: 10, workouts: 5, cleanDays: 7 },
            days: { Mon: { study: 0, workout: false, clean: false }, Tue: { study: 0, workout: false, clean: false }, Wed: { study: 0, workout: false, clean: false }, Thu: { study: 0, workout: false, clean: false }, Fri: { study: 0, workout: false, clean: false }, Sat: { study: 0, workout: false, clean: false }, Sun: { study: 0, workout: false, clean: false } },
            weekendRun: { goal: 5, distance: 0, time: '', day: '' }
        };

        let state = {
            theme: 'light',
            daily: defaultDailyData,
            weekly: defaultWeeklyData,
        };

        // --- FUNÇÕES DE RENDERIZAÇÃO (Templates HTML) ---
        
        const AppShell = () => `
            <header class="mb-8 no-print">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-3xl md:text-4xl font-bold text-text-primary">Plano de Foco Diário</h1>
                    <div class="flex items-center gap-2">
                        <button id="print-btn" class="p-2 rounded-full bg-bg-secondary border border-border-color text-text-secondary hover:text-text-primary transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><path d="M6 14h12v8H6z"></path></svg></button>
                        <button id="theme-btn" class="p-2 rounded-full bg-bg-secondary border border-border-color text-text-secondary hover:text-text-primary transition-colors"></button>
                    </div>
                </div>
                <p class="text-md text-text-secondary">${new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6" id="main-tasks"></div>
            <div id="content-grid" class="space-y-6"></div>
            <footer class="text-center text-sm text-text-secondary mt-8 no-print">
                <p>Seja consistente, não perfeito. Um dia de cada vez.</p>
                <p>UserID: <span id="user-id-display">${userId || 'carregando...'}</span></p>
            </footer>
        `;

        const TaskCard = (id, icon, title, desc, tasks, notes, accentVar) => {
            const taskEntries = Object.entries(tasks);
            const completed = taskEntries.filter(([, v]) => v).length;
            const total = taskEntries.length;
            const progress = total > 0 ? (completed / total) * 100 : 0;
            const taskLabels = { block1: 'Bloco 1 (50/10)', block2: 'Bloco 2 (50/10)', review: 'Revisão Ativa', workout: 'Treino Concluído', cardio: 'Cardio/TAF', cooldown: 'Desaquecimento', dinner: 'Jantar e Hidratação', shower: 'Banho e Higiene', organize: 'Organizar Ambiente (15 min)', read: 'Leitura/Alongamento (sem telas)', prepare: 'Preparar Dia Seguinte', noPhone: 'Celular fora do quarto' };
            return `
                <div class="card p-6 rounded-2xl">
                    <div class="flex items-center gap-4 mb-4"><div style="color: var(${accentVar})">${icon}</div><div><h2 class="text-xl font-bold text-text-primary">${title}</h2><p class="text-sm text-text-secondary">${desc}</p></div></div>
                    <div class="space-y-3 mb-4">${taskEntries.map(([key, checked]) => `<label class="flex items-center p-3 rounded-lg bg-bg-primary cursor-pointer hover:bg-border-color transition-colors"><input type="checkbox" data-category="${id}" data-task="${key}" ${checked ? 'checked' : ''} class="custom-checkbox no-print"><span class="ml-3 text-text-primary ${checked ? 'line-through text-text-secondary' : ''}">${taskLabels[key]}</span></label>`).join('')}</div>
                    <div class="w-full bg-bg-primary rounded-full h-2.5 mb-4"><div class="progress-bar-inner h-2.5 rounded-full" style="width: ${progress}%; background-color: var(${accentVar})"></div></div>
                    ${notes !== null ? `<textarea data-category="${id}" class="notes-area w-full p-2 rounded-lg input-base text-sm" placeholder="Notas rápidas...">${notes}</textarea>` : ''}
                </div>
            `;
        };
        
        const WaterTracker = (completed, goal) => {
            const progress = goal > 0 ? (completed / goal) * 100 : 0;
            const portionsCompleted = Math.floor(completed / (goal / 6));
            return `
                <div class="card p-6 rounded-2xl">
                    <div class="flex items-center gap-4 mb-4"><div style="color: var(--accent-water)"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"></path></svg></div><div><h2 class="text-xl font-bold text-text-primary">Hidratação</h2><p class="text-sm text-text-secondary">Meta: ${goal/1000} litros</p></div></div>
                    <div class="flex items-center gap-4 mb-4"><div class="w-full bg-bg-primary rounded-full h-2.5"><div class="progress-bar-inner h-2.5 rounded-full" style="width: ${progress}%; background-color: var(--accent-water)"></div></div><span class="font-bold text-text-primary whitespace-nowrap">${completed} / ${goal} ml</span></div>
                    <div class="grid grid-cols-6 gap-2 no-print">${Array.from({ length: 6 }).map((_, i) => `<button data-portion="${i+1}" class="water-btn p-2 rounded-lg transition-all duration-200 ${i < portionsCompleted ? 'text-white' : 'text-text-secondary'}" style="${i < portionsCompleted ? 'background-color: var(--accent-water)' : 'background-color: var(--bg-primary)'}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"></path></svg></button>`).join('')}</div>
                </div>
            `;
        };

        const WeeklyTracker = (weekly) => {
            const weekDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const weekDayLabels = { Mon: 'Seg', Tue: 'Ter', Wed: 'Qua', Thu: 'Qui', Fri: 'Sex', Sat: 'Sáb', Sun: 'Dom' };
            const totals = {
                study: Object.values(weekly.days).reduce((acc, day) => acc + (Number(day.study) || 0), 0),
                workouts: Object.values(weekly.days).filter(day => day.workout).length,
                cleanDays: Object.values(weekly.days).filter(day => day.clean).length,
            };
            return `
                <div class="card p-6 rounded-2xl">
                    <div class="flex items-center gap-4 mb-4"><div style="color: var(--accent-primary)"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></div><h2 class="text-xl font-bold text-text-primary">Painel Semanal</h2></div>
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="text-center bg-bg-primary p-3 rounded-lg"><p class="text-sm text-text-secondary">Estudo</p><p class="text-2xl font-bold text-text-primary">${totals.study}h / <input type="number" data-goal="study" value="${weekly.goals.study}" class="w-12 bg-transparent text-center font-bold weekly-goal-input"></p></div>
                        <div class="text-center bg-bg-primary p-3 rounded-lg"><p class="text-sm text-text-secondary">Treinos</p><p class="text-2xl font-bold text-text-primary">${totals.workouts} / <input type="number" data-goal="workouts" value="${weekly.goals.workouts}" class="w-12 bg-transparent text-center font-bold weekly-goal-input"></p></div>
                        <div class="text-center bg-bg-primary p-3 rounded-lg"><p class="text-sm text-text-secondary">Dias Limpos</p><p class="text-2xl font-bold text-text-primary">${totals.cleanDays} / <input type="number" data-goal="cleanDays" value="${weekly.goals.cleanDays}" class="w-12 bg-transparent text-center font-bold weekly-goal-input"></p></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-text-secondary uppercase bg-bg-primary">
                                <tr>
                                    <th class="px-4 py-3">Dia</th>
                                    <th class="px-4 py-3 text-center">Estudo (h)</th>
                                    <th class="px-4 py-3 text-center">Treino</th>
                                    <th class="px-4 py-3 text-center">Dia Limpo</th>
                                </tr>
                            </thead>
                            <tbody class="text-text-primary">
                                ${weekDays.map(day => `
                                    <tr class="border-b border-border-color">
                                        <td class="px-4 py-3 font-medium">${weekDayLabels[day]}</td>
                                        <td class="px-4 py-3">
                                            <input type="number" data-day="${day}" data-field="study" value="${weekly.days[day].study}" class="w-full rounded p-1 text-center weekly-day-input input-base">
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <input type="checkbox" data-day="${day}" data-field="workout" ${weekly.days[day].workout ? 'checked' : ''} class="custom-checkbox weekly-day-input">
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <input type="checkbox" data-day="${day}" data-field="clean" ${weekly.days[day].clean ? 'checked' : ''} class="custom-checkbox weekly-day-input">
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };
        
        const WeekendRunTracker = (runData) => {
             const progress = runData.goal > 0 ? (runData.distance / runData.goal) * 100 : 0;
             return `
                <div class="card p-6 rounded-2xl">
                    <div class="flex items-center gap-4 mb-4"><div style="color: var(--accent-run)"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg></div><div><h2 class="text-xl font-bold text-text-primary">Corrida do Fim de Semana</h2><p class="text-sm text-text-secondary">Meta: ${runData.goal} km</p></div></div>
                    <div class="flex items-center gap-4 mb-4"><div class="w-full bg-bg-primary rounded-full h-2.5"><div class="progress-bar-inner h-2.5 rounded-full" style="width: ${progress}%; background-color: var(--accent-run)"></div></div><span class="font-bold text-text-primary whitespace-nowrap">${runData.distance} / ${runData.goal} km</span></div>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div><label class="block text-sm font-medium text-text-secondary mb-1">Distância (km)</label><input type="number" data-run-field="distance" value="${runData.distance}" class="run-input w-full p-2 rounded-lg input-base"></div>
                        <div><label class="block text-sm font-medium text-text-secondary mb-1">Tempo</label><input type="text" data-run-field="time" value="${runData.time}" placeholder="00:00" class="run-input run-input-time w-full p-2 rounded-lg input-base"></div>
                        <div><label class="block text-sm font-medium text-text-secondary mb-1">Dia</label><select data-run-field="day" class="run-input w-full p-2 rounded-lg input-base"><option value="" ${runData.day === '' ? 'selected' : ''}>Selecione</option><option value="Sat" ${runData.day === 'Sat' ? 'selected' : ''}>Sábado</option><option value="Sun" ${runData.day === 'Sun' ? 'selected' : ''}>Domingo</option></select></div>
                    </div>
                </div>
             `;
        };

        // --- FUNÇÃO PRINCIPAL DE RENDERIZAÇÃO ---
        function render() {
            const container = document.getElementById('app-container');
            if (!container) return;

            // Renderiza o esqueleto da aplicação apenas uma vez
            if (!isShellRendered) {
                container.innerHTML = AppShell();
                isShellRendered = true;
            }
            
            const mainTasksGrid = document.getElementById('main-tasks');
            const contentGrid = document.getElementById('content-grid');
            const { daily, weekly } = state;

            if (mainTasksGrid && contentGrid) {
                mainTasksGrid.innerHTML = `
                    ${TaskCard('study', '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>', 'Estudo Matinal', 'Foco total para o aprendizado.', daily.study.tasks, daily.study.notes, '--accent-study')}
                    ${TaskCard('gym', '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.4 14.4 9.6 9.6M9.6 14.4 14.4 9.6M21 9.6 17 5.6M4 20l4-4M17 18.4 21 14.4M10 5.6 6 1.6M4 8 8 4M18.4 17l-4-4"></path></svg>', 'Academia', 'Libere o estresse.', daily.gym.tasks, daily.gym.notes, '--accent-gym')}
                `;

                contentGrid.innerHTML = `
                    ${TaskCard('selfCare', '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>', 'Autocuidado', 'Rotina noturna para um sono de qualidade.', daily.selfCare.tasks, null, '--accent-care')}
                    ${WaterTracker(daily.water.completed, daily.water.goal)}
                    ${WeeklyTracker(weekly)}
                    ${WeekendRunTracker(weekly.weekendRun)}
                `;
            }

            updateThemeUI();
            addEventListeners();
        }

        // --- LÓGICA DE EVENTOS E ATUALIZAÇÃO ---
        let debounceTimer;
        function debounceUpdateFirestore() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updateFirestore();
            }, 500);
        }

        function updateThemeUI() {
            const themeBtn = document.getElementById('theme-btn');
            if(!themeBtn) return;

            if (state.theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
            } else {
                document.documentElement.classList.remove('dark');
                themeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
            }
        }

        function addEventListeners() {
            const container = document.getElementById('app-container');
            if (!container) return;

            container.onclick = (e) => {
                const themeBtn = e.target.closest('#theme-btn');
                const printBtn = e.target.closest('#print-btn');
                const waterBtn = e.target.closest('.water-btn');
                const checkbox = e.target.closest('input[type="checkbox"]');

                if (themeBtn) {
                    state.theme = state.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('productivity-theme', state.theme);
                    updateThemeUI();
                }
                if (printBtn) window.print();
                if (waterBtn) {
                    const portion = Number(waterBtn.dataset.portion);
                    state.daily.water.completed = portion * (state.daily.water.goal / 6);
                    updateFirestore();
                }
                if (checkbox && checkbox.dataset.category) {
                    const { category, task } = checkbox.dataset;
                    state.daily[category].tasks[task] = checkbox.checked;
                    updateFirestore();
                }
            };
            
            container.oninput = (e) => {
                const notesArea = e.target.closest('.notes-area');
                const weeklyGoalInput = e.target.closest('.weekly-goal-input');
                const runInput = e.target.closest('.run-input');
                const weeklyDayInput = e.target.closest('.weekly-day-input');

                if (notesArea) {
                    state.daily[notesArea.dataset.category].notes = notesArea.value;
                }
                if (weeklyGoalInput) {
                    state.weekly.goals[weeklyGoalInput.dataset.goal] = Number(weeklyGoalInput.value);
                }
                if (runInput) {
                    if (runInput.classList.contains('run-input-time')) {
                        let value = runInput.value.replace(/\D/g, '');
                        if (value.length > 4) value = value.substring(0, 4);
                        if (value.length > 2) value = value.substring(0, 2) + ':' + value.substring(2);
                        runInput.value = value;
                        state.weekly.weekendRun.time = value;
                    } else {
                        const field = runInput.dataset.runField;
                        const value = field === 'distance' ? Number(runInput.value) : runInput.value;
                        state.weekly.weekendRun[field] = value;
                    }
                }
                if (weeklyDayInput) {
                    const { day, field } = weeklyDayInput.dataset;
                    const value = weeklyDayInput.type === 'checkbox' ? weeklyDayInput.checked : Number(weeklyDayInput.value);
                    state.weekly.days[day][field] = value;
                }
                debounceUpdateFirestore();
            };
        }
        
        async function updateFirestore() {
            if (!userId) return;
            const dailyDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyLogs`, getTodayDateString());
            await setDoc(dailyDocRef, state.daily);
            const weeklyDocRef = doc(db, `artifacts/${appId}/users/${userId}/weeklyGoals`, getWeekId(new Date()));
            await setDoc(weeklyDocRef, state.weekly);
        }

        // --- INICIALIZAÇÃO ---
        function init() {
            state.theme = localStorage.getItem('productivity-theme') || 'light';
            if (state.theme === 'dark') document.documentElement.classList.add('dark');
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) { userId = user.uid; } 
                else {
                    try { const { user: anonUser } = await signInAnonymously(auth); userId = anonUser.uid; } 
                    catch (error) {
                        console.error("Login anônimo falhou:", error);
                        document.getElementById('loader').innerText = "Erro ao conectar.";
                        return;
                    }
                }
                
                const dailyDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyLogs`, getTodayDateString());
                onSnapshot(dailyDocRef, (docSnap) => {
                    state.daily = { ...defaultDailyData, ...(docSnap.data() || {}) };
                    render();
                });
                
                const weeklyDocRef = doc(db, `artifacts/${appId}/users/${userId}/weeklyGoals`, getWeekId(new Date()));
                onSnapshot(weeklyDocRef, (docSnap) => {
                    const data = docSnap.data() || {};
                    state.weekly = { ...defaultWeeklyData, ...data, weekendRun: {...defaultWeeklyData.weekendRun, ...data.weekendRun} };
                    render();
                });

                document.getElementById('loader').style.display = 'none';
                document.getElementById('app-container').classList.remove('opacity-0');
            });
        }

        init();
    </script>
</body>
</html>
